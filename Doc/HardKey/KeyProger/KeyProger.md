<p align="left">
<h2 align="center">Настройка USB ключа.</h2>
</p>
<p>
Для создания аппаратного ключа потребуется плата с микроконтроллером stm32f103c8t6. 
Подобная плата обычно имеет название «stm32 blue pill» или «отладочная плата STM32». Важно купить плату с оригинальным микроконтроллером от фирмы st microelectronics. Так как существует достаточно много копий с китайским ARM.<br>
<img src="./Images/Stm32Board.jpg" width="50%">
</p>
<p>
Скачиваем IDE Keil v5.36. Собираем прошивку из \HardwareProjects\STM32UsbKey.
Или берем готовую из \Binaries\STM32UsbKeyFirmware.zip. 
<a href="../LoadFirmware/LoadFirmware.md">Прошиваем микроконтроллер.</a>
</p>
<p>
Генерируем ключ RSA, которым микроконтроллер будет шифровать сеансовый ключ.
Для этого из Git Bash запускаем \Native\HardwareKeyExample\KeyProger\genkey.bat.
Git Bash знает где лежит openssl, поэтому используем его (должен быть установлен git и tortoise git).<br>
<img src="./Images/GitBash0.jpg" width="30%"><br>
<img src="./Images/GitBash.jpg" width="70%">
</p>
<p>
В .bat файле указано:<br>
Генерация RSA ключа длиной 2048 бит, и помещение его в .pem контейнер.<br>
Конвертируем ключ из формата .pem в pkc8.<br>
Удаление ключа в формате pem.<br>
</p>
<p>
В корне папки будет создан файл закрытого ключа rsa - "privateKey".
</p>
<p>
Для загрузки серийного номера и ключа RSA в флеш память микроконтроллера, используется программа «KeyProger».
Исходники можно найти в \Native\HardwareKeyExample\KeyProger
</p>
<p>
После запуска – возможен выбор двух режимов.<br>
<img src="./Images/MainWindow.jpg" width="50%">
</p>
<p>
Режим «простого пользователя» позволяет загрузить серийный номер и ключ RSA:<br>
<img src="./Images/EasyMode.jpg" width="50%">
</p>
<p>
Для настройки ключа потребуется режим «эксперт».
</p>
<p>
Для входа в режим «эксперт» потребуется ввести пароль, прописанный в файле \Native\HardwareKeyExample\KeyProger\config.h<br>
<img src="./Images/EnableExpert.jpg" width="50%">
</p>
<p>
Если у вас надписи вылезли за размер кнопок – необходимо установить масштаб 100% и разрешение 1920х1080. Окно программы должно выглядеть как показано на рисунке:<br>
</p>
<p>
<img src="./Images/ExpertMode.jpg" width="50%">
</p>
<p>
1. Устанавливаем дату, от которой вы хотите вести внутренний отсчет в днях – например 01.01.2023. Нажимаем кнопку «Set Last Date». Наличие даты необходимо для исключения возможностей ее подделки на ПК, где будет работать защищаемая программа.<br>
Потребуется ключ продукта и ключ rsa .
</p>
<p>
2. Копируем файл ключа «privateKey» в папку где собрана программа (\KeyProger\Win32\Debug\). 
Нажимаем кнопку «Load New RSA Key». Программа считает закрытый ключ rsa. В корне защищаемой программы будет создан заголовочный файл (ProtectionApp\uVectors.h), содержащий зашифрованный закрытый ключ (при сборке программы он будет вшит  в нее).  В аппаратный ключ будет записан модуль n закрытого ключа rsa. Длина модуля 256 байт.
</p>
<p>
3. Далее нам потребуется актуальный серийный ключ продукта. Запустим проект ProductKeyGen.<br>
<img src="./Images/KeyGenWindow.jpg" width="100%"><br>
Вводим примечание, нажимаем  «Генерировать».<br>
<img src="./Images/KeyGenWindow1.jpg" width="100%"><br>
</p>
<p>
4. Копируем серийный номер продукта "BCBC9-MXCY5-WAGMI-J20TF-C6F40". Очищаем поле ввода, содержащее 5 групп нулей. Вставляем скопированную строку. Очищаем поле ввода, содержащее 5 групп нулей. Вставляем скопированную строку. Нажимаем «SetSerial».<br>
<img src="./Images/SetProductSerial.jpg" width="50%"><br>
</p>
<p>
Запускаем защищаемое приложение (ProtectionApp), видим разблокированную форму входа.<br>
<img src="./Images/UnlockLoginForm.jpg" width="50%"><br>
</p>